<?xml version="1.0"?>
<!-- *****************************************************************************
Copyright 2017 Ellucian Company L.P. and its affiliates.
 ********************************************************************************* -->
<SQL_VALIDATION>
    <PERFORMANCE_SQL>
        <!-- copy where clause to parsed sql for all HEDM_EXTENSIONS that have not been validated -->
        <SQL_CODE><![CDATA[DECLARE
  lv_secure       VARCHAR2(01);
  lv_err          VARCHAR2(01);
  lv_err_msg      VARCHAR2(500);
  CURSOR guruobj_c IS
    SELECT NVL(MAX('Y'),'N')
      FROM bansecr.guruobj
     WHERE guruobj_object = 'ENABLE_GORRSQL_DML'
       AND guruobj_userid = USER;
  CURSOR gorrsql_c(p_sqpr_code VARCHAR2) IS
    SELECT gorrsql_sqpr_code AS sqpr_code,
           gorrsql_sqru_code AS sqru_code,
           gorrsql_seq_no AS seq_no,
           REPLACE(gorrsql_where_clause, CHR(34), CHR(39)) AS where_clause
      FROM gorrsql
     WHERE gorrsql_sqpr_code = p_sqpr_code
       AND gorrsql_validated_ind = 'N';
BEGIN
  OPEN guruobj_c;
  FETCH guruobj_c INTO lv_secure;
  CLOSE guruobj_c;
  IF lv_secure = 'N' THEN
    INSERT INTO BANSECR.GURUOBJ (GURUOBJ_OBJECT, GURUOBJ_ROLE, GURUOBJ_USERID, GURUOBJ_ACTIVITY_DATE, GURUOBJ_USER_ID)
    VALUES ('ENABLE_GORRSQL_DML', 'BAN_DEFAULT_M', USER, SYSDATE, USER);
  END IF;
  FOR results IN gorrsql_c('HEDM_EXTENSIONS') LOOP
    lv_err := 'N';
    IF GOKRSQL.F_Validate_SQL_Rule (results.sqpr_code, results.where_clause, lv_err_msg) THEN
      UPDATE gorrsql
         SET gorrsql_validated_ind = 'Y',
             gorrsql_where_clause = results.where_clause,
             gorrsql_parsed_sql = results.where_clause,
             gorrsql_activity_date = sysdate
       WHERE gorrsql_sqpr_code = results.sqpr_code
         AND gorrsql_sqru_code = results.sqru_code
         AND gorrsql_seq_no = results.seq_no;
    ELSE
      IF lv_secure = 'N' THEN
        DELETE FROM BANSECR.GURUOBJ WHERE GURUOBJ_OBJECT = 'ENABLE_GORRSQL_DML' AND GURUOBJ_USERID = USER;
      END IF;
      raise_application_error (-20001,'Invalid SQL for '||results.sqpr_code||'/'||results.sqru_code||'/'||results.seq_no||': '||lv_err_msg);
    END IF;
  END LOOP;
  IF lv_secure = 'N' THEN
    DELETE FROM BANSECR.GURUOBJ WHERE GURUOBJ_OBJECT = 'ENABLE_GORRSQL_DML' AND GURUOBJ_USERID = USER;
  END IF;
  COMMIT;
END;]]></SQL_CODE>
    </PERFORMANCE_SQL>
</SQL_VALIDATION>
