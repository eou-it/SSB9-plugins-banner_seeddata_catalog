<?xml version="1.0"?>
<!-- *****************************************************************************
Copyright 2017 Ellucian Company L.P. and its affiliates.
 ********************************************************************************* -->
<SQL_VALIDATION>
    <PERFORMANCE_SQL>
        <SQL_CODE><![CDATA[-- copy where clause to parsed sql for all HEDM_EXTENSIONS that have not been validated
DECLARE
  lv_secure       VARCHAR2(01);
  lv_err_msg      VARCHAR2(500);
  lv_sqpr_code    gorrsql.gorrsql_sqpr_code%TYPE;
  lv_sqru_code    gorrsql.gorrsql_sqru_code%TYPE;
  lv_seq_no       gorrsql.gorrsql_seq_no%TYPE;
  lv_where_clause gorrsql.gorrsql_where_clause%TYPE;
  lv_owner        VARCHAR2(30);
  lv_table        VARCHAR2(30);
  lv_err          VARCHAR2(01);
  CURSOR guruobj_c IS
    SELECT NVL(MAX('Y'),'N')
      FROM bansecr.guruobj
     WHERE guruobj_object = 'ENABLE_GORRSQL_DML'
       AND guruobj_userid = USER;
  CURSOR gorrsql_c IS
    SELECT gorrsql_sqpr_code,
           gorrsql_sqru_code,
           gorrsql_seq_no,
           REPLACE(gorrsql_where_clause, CHR(34), CHR(39))
      FROM gorrsql
     WHERE gorrsql_sqpr_code = 'HEDM_EXTENSIONS'
       AND gorrsql_validated_ind = 'N';
BEGIN
  OPEN guruobj_c;
  FETCH guruobj_c INTO lv_secure;
  CLOSE guruobj_c;
  IF lv_secure = 'N' THEN
    INSERT INTO BANSECR.GURUOBJ (GURUOBJ_OBJECT, GURUOBJ_ROLE, GURUOBJ_USERID, GURUOBJ_ACTIVITY_DATE, GURUOBJ_USER_ID)
    VALUES ('ENABLE_GORRSQL_DML', 'BAN_DEFAULT_M', USER, SYSDATE, USER);
  END IF;
  OPEN gorrsql_c;
  LOOP
    lv_err := 'N';
    FETCH gorrsql_c INTO lv_sqpr_code, lv_sqru_code, lv_seq_no, lv_where_clause;
    EXIT WHEN gorrsql_c%NOTFOUND;
    IF GOKRSQL.F_Validate_SQL_Rule (lv_sqpr_code, lv_where_clause, lv_err_msg) THEN
      UPDATE gorrsql
         SET gorrsql_validated_ind = 'Y',
             gorrsql_where_clause = lv_where_clause,
             gorrsql_parsed_sql = lv_where_clause,
             gorrsql_activity_date = sysdate
       WHERE gorrsql_sqpr_code = lv_sqpr_code
         AND gorrsql_sqru_code = lv_sqru_code
         AND gorrsql_seq_no = lv_seq_no;
    ELSE
      IF lv_secure = 'N' THEN
        DELETE FROM BANSECR.GURUOBJ WHERE GURUOBJ_OBJECT = 'ENABLE_GORRSQL_DML' AND GURUOBJ_USERID = USER;
      END IF;
      raise_application_error (-20001,'Invalid SQL for '||lv_sqpr_code||'/'||lv_sqru_code||'/'||lv_seq_no||': '||lv_err_msg);
    END IF;
  END LOOP;
  CLOSE gorrsql_c;
  IF lv_secure = 'N' THEN
    DELETE FROM BANSECR.GURUOBJ WHERE GURUOBJ_OBJECT = 'ENABLE_GORRSQL_DML' AND GURUOBJ_USERID = USER;
  END IF;
END;]]></SQL_CODE>
    </PERFORMANCE_SQL>
</SQL_VALIDATION>
